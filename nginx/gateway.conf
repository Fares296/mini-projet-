# ============================================
# API Gateway NGINX - Configuration
# ============================================
# Point d'entr√©e unique pour tous les microservices
# Expos√© sur le port 8080
# ============================================

# Upstream pour le microservice Users (Load Balancing x3 instances)
upstream users-backend {
    # Strat√©gie de load balancing: round-robin (par d√©faut)
    # Autres options disponibles:
    # least_conn;      # Connexion avec le moins de requ√™tes actives
    # ip_hash;         # M√™me client toujours dirig√© vers le m√™me serveur
    
    # Instance 1
    server users-service-1:3000 max_fails=3 fail_timeout=30s;
    
    # Instance 2
    server users-service-2:3000 max_fails=3 fail_timeout=30s;
    
    # Instance 3
    server users-service-3:3000 max_fails=3 fail_timeout=30s;
    
    # Maintenir des connexions persistantes pour de meilleures performances
    keepalive 32;
}

# Upstream pour le microservice Products
upstream products-backend {
    server products-service:3001;
    # server products-service-2:3001;  # Pour scaling futur
    
    keepalive 32;
}

# Upstream pour Prometheus (monitoring)
upstream prometheus-backend {
    server prometheus:9090;
    keepalive 16;
}

# Configuration du serveur principal
server {
    listen 80;
    server_name localhost;
    
    # Logs personnalis√©s pour le Gateway
    access_log /var/log/nginx/gateway_access.log combined;
    error_log /var/log/nginx/gateway_error.log warn;
    
    # Timeout configurations
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer configurations pour am√©liorer les performances
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # Headers communs pour tous les proxys
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Gateway-Version "1.0";
    
    # ==================== PAGE D'ACCUEIL DU GATEWAY ====================
    
    location = / {
        default_type application/json;
        return 200 '{\n  "message": "üöÄ API Gateway - Architecture Cloud-Native",\n  "version": "1.0.0",\n  "services": {\n    "users": "http://localhost:8080/users",\n    "products": "http://localhost:8080/products",\n    "prometheus": "http://localhost:8080/prometheus"\n  },\n  "endpoints": {\n    "users-service": [\n      "GET /users - Lister tous les utilisateurs",\n      "GET /users/:id - Consulter un utilisateur",\n      "POST /users - Cr√©er un utilisateur",\n      "DELETE /users/:id - Supprimer un utilisateur"\n    ],\n    "products-service": [\n      "GET /products - Lister tous les produits",\n      "GET /products/:id - Consulter un produit",\n      "GET /products/category/:category - Filtrer par cat√©gorie",\n      "POST /products - Cr√©er un produit",\n      "PUT /products/:id - Mettre √† jour un produit",\n      "DELETE /products/:id - Supprimer un produit"\n    ]\n  },\n  "monitoring": {\n    "prometheus": "http://localhost:8080/prometheus",\n    "metrics": {\n      "users": "http://localhost:8080/users/metrics",\n      "products": "http://localhost:8080/products/metrics"\n    }\n  },\n  "status": "operational"\n}\n';
        add_header Content-Type application/json;
        add_header X-Gateway-Response "true";
    }
    
    # ==================== HEALTH CHECK DU GATEWAY ====================
    
    location /health {
        default_type application/json;
        access_log off;
        return 200 '{"status": "healthy", "gateway": "nginx", "timestamp": "$time_iso8601"}\n';
        add_header Content-Type application/json;
    }
    
    # ==================== MICROSERVICE USERS ====================
    
    # Redirection de /users vers le microservice users-service
    location /users {
        # R√©√©criture de l'URL pour enlever le pr√©fixe /users si n√©cessaire
        # Dans notre cas, on garde /users car le service l'attend
        
        proxy_pass http://users-backend;
        
        # Headers sp√©cifiques
        add_header X-Served-By "API-Gateway-NGINX";
        add_header X-Service "users-service";
        add_header X-Upstream-Server $upstream_addr;  # Indique quelle instance a r√©pondu
        
        # CORS pour applications frontend
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        
        # Gestion des requ√™tes OPTIONS (preflight CORS)
        if ($request_method = OPTIONS) {
            return 204;
        }
    }
    
    # ==================== MICROSERVICE PRODUCTS ====================
    
    # Redirection de /products vers le microservice products-service
    location /products {
        proxy_pass http://products-backend;
        
        # Headers sp√©cifiques
        add_header X-Served-By "API-Gateway-NGINX";
        add_header X-Service "products-service";
        
        # CORS
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        
        if ($request_method = OPTIONS) {
            return 204;
        }
    }
    
    # ==================== MONITORING - PROMETHEUS ====================
    
    # Acc√®s √† Prometheus via le Gateway
    location /prometheus/ {
        proxy_pass http://prometheus-backend/;
        
        add_header X-Served-By "API-Gateway-NGINX";
        
        # Configuration sp√©cifique pour Prometheus
        proxy_set_header Accept-Encoding "";
        sub_filter_types *;
        sub_filter 'href="/' 'href="/prometheus/';
        sub_filter 'src="/' 'src="/prometheus/';
        sub_filter_once off;
    }
    
    # Prometheus sans le trailing slash
    location = /prometheus {
        return 301 /prometheus/;
    }
    
    # ==================== RATE LIMITING (Optionnel) ====================
    
    # Zone de rate limiting d√©finie en dehors du bloc server
    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
    
    # Exemple d'application du rate limiting sur un endpoint
    # location /products {
    #     limit_req zone=api_limit burst=20 nodelay;
    #     proxy_pass http://products-backend;
    # }
    
    # ==================== CACHE (Optionnel) ====================
    
    # Cache pour les requ√™tes GET sur les produits
    # location /products {
    #     proxy_cache products_cache;
    #     proxy_cache_valid 200 5m;
    #     proxy_cache_key "$scheme$request_method$host$request_uri";
    #     add_header X-Cache-Status $upstream_cache_status;
    #     
    #     proxy_pass http://products-backend;
    # }
    
    # ==================== GESTION DES ERREURS ====================
    
    # Page d'erreur 404 personnalis√©e
    error_page 404 = @not_found;
    location @not_found {
        default_type application/json;
        return 404 '{"success": false, "error": "Route not found", "gateway": "nginx"}\n';
    }
    
    # Page d'erreur 502/503/504 (Backend indisponible)
    error_page 502 503 504 = @backend_error;
    location @backend_error {
        default_type application/json;
        return 503 '{"success": false, "error": "Service temporairement indisponible", "gateway": "nginx", "retry_after": 5}\n';
    }
    
    # ==================== S√âCURIT√â ====================
    
    # Cacher la version de NGINX
    server_tokens off;
    
    # Protection contre les requ√™tes malform√©es
    client_body_buffer_size 1K;
    client_header_buffer_size 1k;
    client_max_body_size 10M;
    large_client_header_buffers 2 1k;
}

# ============================================
# Configuration HTTP globale
# (En dehors du bloc server, au niveau http)
# ============================================

# Zone de rate limiting
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

# Cache zone pour les produits
# proxy_cache_path /var/cache/nginx/products levels=1:2 keys_zone=products_cache:10m max_size=100m inactive=60m use_temp_path=off;
